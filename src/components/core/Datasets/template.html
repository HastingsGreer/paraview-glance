<v-expansion-panels
  v-model="panelStates"
  multiple
>
  <v-expansion-panel
    v-for="(source, index) in datasets"
    v-show="source !== proxyToDelete"
    :key="source.getProxyId()"
    :class="$style.datasetPanel"
  >
    <color-group
      :index="index"
      :visible="datasets.length > 1"
      :top="53"
    />
    <v-expansion-panel-header
      :class="$style.datasetHeader"
      :title="source.getName()"
    >
      <v-btn
        :class="$style.headerMenuButton"
        icon
        small
        v-on:click.stop="toggleDatasetVisibility(source)"
      >
        <v-icon>
          {{ getDatasetVisibility(source) ? 'visibility' : 'visibility_off' }}
        </v-icon>
      </v-btn>
      <div
        class="body-2"
        :class="$style.source"
      >{{ source.getName() }}</div>
      <v-tooltip
        v-if="proxyManager.getSources().length > 1"
        top
        :disabled="smallScreen"
      >
        <span :class="$style.noSelect">Activate source</span>
        <template v-slot:activator="{ on }">
          <v-btn
            :class="$style.headerMenuButton"
            icon
            small
            v-on="on"
            v-on:click.stop="source.activate()"
          >
            <v-icon>{{ proxyManager.getActiveSource() === source ? 'bookmark' : 'bookmark_border' }}</v-icon>
          </v-btn>
        </template>
      </v-tooltip>
      <div v-on:click.stop> <!-- prevent panel expansion on menu click -->
        <v-menu offset-x>
          <template v-slot:activator="{ on }">
            <v-btn
              :class="$style.headerMenuButton"
              icon
              small
              v-on="on"
            >
              <v-icon>more_vert</v-icon>
            </v-btn>
          </template>
          <v-list dense>
            <v-list-item
              v-on:click="deleteDataset(source)"
            >
              <v-list-item-title>Delete</v-list-item-title>
            </v-list-item>
          </v-list>
        </v-menu>
      </div>
    </v-expansion-panel-header>
    <v-expansion-panel-content>
      <v-card :class="$style.datasetControls">
        <v-expansion-panels
          v-model="subpanelStateMap.get(source)"
          multiple
        >
          <v-expansion-panel
            v-for="(panel,i) in panels"
            :key="i"
            v-show="panel.visible(source)"
          >
            <v-expansion-panel-header :class="$style.subpanelHeader">
              <v-layout row align-center>
                <v-flex shrink>
                  <v-icon>{{ panel.icon }}</v-icon>
                </v-flex>
                <v-flex shrink :class="$style.subpanelTitle">
                  <span class="body-2">{{ panel.name }}</span>
                </v-flex>
              </v-layout>
            </v-expansion-panel-header>
            <v-expansion-panel-content>
              <component
                v-if="panel.visible(source)"
                :is="panel.component"
                :source="source"
              />
            </v-expansion-panel-content>
          </v-expansion-panel>
        </v-expansion-panels>
      </v-card>
    </v-expansion-panel-content>
  </v-expansion-panel>
</v-expansion-panels>
